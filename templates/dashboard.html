<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>V E X A</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<style></style>

<body>
    <div class="sidebar" id="sidebar">
        <div class="toggle-sidebar" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>

        <a href="{{ url_for('compose') }}" class="sidebar-btn {% if active_page == 'compose' %}active{% endif %}"
            title="Compose">
            <i class="fas fa-pencil-alt"></i><span>Compose</span>
        </a>

        <a href="{{ url_for('dashboard') }}" class="sidebar-btn {% if active_page == 'inbox' %}active{% endif %}"
            title="Inbox">
            <i class="fas fa-inbox"></i><span>Inbox</span>
        </a>


        <a href="/?filter=unread" class="sidebar-btn {% if active_page == 'unread' %}active{% endif %}" title="Unread">
            <i class="fas fa-envelope-open-text"></i><span>Unread</span>
        </a>

        <a href="/?filter=read" class="sidebar-btn {% if active_page == 'read' %}active{% endif %}" title="Read">
            <i class="fas fa-envelope"></i><span>Read</span>
        </a>

        <a href="/?filter=archived" class="sidebar-btn {% if active_page == 'archived' %}active{% endif %}"
            title="Archived">
            <i class="fas fa-archive"></i><span>Archived</span>
        </a>

        <a href="{{ url_for('sent') }}" class="sidebar-btn {% if active_page == 'sent' %}active{% endif %}"
            title="Sent">
            <i class="fas fa-paper-plane"></i><span>Sent</span>
        </a>

        <a href="{{ url_for('logout') }}" class="sidebar-btn logout" title="Logout">
            <i class="fas fa-sign-out-alt"></i><span>Logout</span>
        </a>
    </div>


    <div class="main-content">
        <div class="top-bar">
            <div class="left-title">
                <h2> V E X A
                    {% if current_user.is_authenticated and current_user.is_admin %}
                    <span class="admin-crown" title="Admin"></span>
                    {% endif %}
                </h2>
            </div>

            <div class="right-info">
                <!-- EVA Mic Button -->
                <button class="eva-mic-btn" onclick="startVoiceCommand()" title="Talk to EVA">
                    <i class="fa-solid fa-microphone"></i> Talk to EVA</i>
                </button>

                {% if current_user.is_authenticated %}
                <span class="user-info">üë§ {{ current_user.email }}</span>
                {% endif %}


                <button class="toggle-btn" onclick="toggleDarkMode()">üåô Dark Mode</button>
            </div>
        </div>


        <div class="search-bar">
            <form method="get" action="/">
                <input type="text" name="q" class="search-input" placeholder="Search by sender, subject..."
                    value="{{ query }}">
                <input type="hidden" name="filter" value="{{ filter_mode }}">
                <button type="submit"><i class="fas fa-search"></i> Search</button>
            </form>
        </div>

        {% for email in emails %}
        <div class="email {{ email.classification | lower }}">
            <p><strong>From:</strong> {{ email.sender }}</p>
            <p><strong>Subject:</strong> {{ email.subject }}</p>
            <p><strong>Category:</strong> {{ email.classification }}</p>
            <p><strong>Summary:</strong> {{ email.summary }}</p>
            <p><strong>Priority:</strong>
                <span class="badge priority-{{ email.priority | lower }}">{{ email.priority }}</span>
            </p>
            <small>{{ email.timestamp | format_datetime }}</small>

            {% if email.archived %}
            <span class="badge archived">üìÅ Archived</span>
            {% endif %}

            {% if email.read %}
            <span class="badge read">‚úÖ Read</span>
            {% else %}
            <span class="badge unread">üî¥ Unread</span>
            <button onclick="markAsRead(this, '{{ email.subject }}')">‚úîÔ∏è Mark as Read</button>
            {% endif %}

            <form action="/reply" method="post">
                <input type="hidden" name="to" value="{{ email.sender }}">
                <textarea name="message" rows="2" placeholder="Type your reply..." required></textarea>
                <button type="submit"><i class="fas fa-reply"></i> Reply</button>
            </form>

            <button class="small-btn archive-btn" onclick="archiveEmail('{{ email.subject }}')" title="Archive">
                <i class="fas fa-box"></i>
            </button>

            <button class="small-btn delete-btn" onclick="deleteEmail('{{ email.subject }}')" title="Delete">
                <i class="fas fa-trash"></i>
            </button>

        </div>

        <div class="email">
            <div class="email-header">
                <strong>{{ email.subject }}</strong> - {{ email.from or email.to }}
                <button class="toggle-details-btn" onclick="toggleDetails(this)">‚ñº View Details</button>
            </div>

            <div class="email-summary">
                {{ email.summary or email.subject }}
            </div>
            {% if email.attachments %}
            <p><strong>Attachments:</strong></p>
            <ul>
                {% for filename in email.attachments.split(',') %}
                <li>
                    <a href="{{ url_for('download_attachment', filename=filename.strip()) }}" target="_blank">
                        üìé {{ filename.strip() }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% endif %}


            <div class="email-details" style="display: none;">
                <p id="email-body" class="email-read-body">
                    {% if email.body %}
                    {{ email.body.replace('\n', '<br>') | safe }}
                    {% else %}
                    <em>No body available.</em>
                    {% endif %}
                </p>
                <!-- <p id="email-body">
                    <span id="email-text">
                        {% if email.body %}
                        {{ email.body.replace('\n', '<br>') | safe }}
                        {% else %}
                        <em>No body available.</em>
                        {% endif %}
                    </span>
                </p> -->

                <button class="read-aloud-btn" title="Read Full Email Aloud">
                    <i class="fas fa-volume-up"></i> Read Aloud
                </button>
                <label class="voice-label" style="color: #fff;">Voice:</label>
                <select class="voiceSelect" style="padding: 4px; border-radius: 4px;">
                    <option value="">Loading voices...</option>
                </select>

                {% if email.attachments %}
                <p><strong>Attachments:</strong></p>
                <ul>
                    {% for filename in email.attachments.split(',') %}
                    <li>
                        <a href="{{ url_for('download_attachment', filename=filename.strip()) }}" target="_blank">
                            {{ filename.strip() }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <div class="smart-reply">
            <h3>üí° Smart Reply</h3>
            <form id="smart-reply-form">
                <textarea id="email_content" placeholder="Paste email content..." rows="3" required></textarea>
                <button type="submit"><i class="fas fa-bolt"></i> Generate Smart Reply</button>
            </form>
            <div id="smart-reply-result"></div>
        </div>
    </div>


    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }
        function toggleDetails(btn) {
            const details = btn.closest('.email').querySelector('.email-details');
            const isVisible = details.style.display === 'block';
            details.style.display = isVisible ? 'none' : 'block';
            btn.textContent = isVisible ? '‚ñº View Details' : '‚ñ≤ Hide';
        }
    </script>

    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>

    <a href="{{ url_for('compose') }}" class="compose-email">
        <i class="fas fa-pencil-alt"></i>
        <span class="compose-label">Compose</span>
    </a>

    <script>
        function markAsRead(button, subject) {
            fetch('/mark_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subject: subject })
            }).then(res => {
                if (res.ok) {
                    const emailCard = button.closest('.email');
                    button.remove();  // remove the "Mark as Read" button

                    // Update unread badge to read
                    const unreadBadge = emailCard.querySelector('.badge.unread');
                    if (unreadBadge) {
                        unreadBadge.textContent = '‚úÖ Read';
                        unreadBadge.classList.remove('unread');
                        unreadBadge.classList.add('read');
                    }
                }
            });
        }

        function deleteEmail(subject) {
            fetch('/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subject: subject })
            }).then(res => {
                if (res.ok) {
                    const emailCard = document.querySelector(`.email:has(button[onclick*="${subject}"])`);
                    if (emailCard) {
                        emailCard.remove();  // instantly remove email from view
                    }
                }
            });
        }

        function archiveEmail(subject) {
            fetch('/archive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subject: subject })
            }).then(res => {
                if (res.ok) {
                    const emailCard = document.querySelector(`.email:has(button[onclick*="${subject}"])`);
                    const archivedBadge = document.createElement('span');
                    archivedBadge.className = 'badge archived';
                    archivedBadge.textContent = 'üìÅ Archived';
                    emailCard.insertBefore(archivedBadge, emailCard.children[0]); // Add badge
                }
            });
        }
    </script>
    <script>
        function startVoiceCommand() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                alert("Sorry, your browser does not support speech recognition.");
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();

            recognition.onstart = () => {
                alert("üéô EVA is listening...");
            };

            recognition.onresult = function (event) {
                const command = event.results[0][0].transcript.toLowerCase();
                console.log("EVA heard:", command);

                // Handle simple commands
                if (command.includes("logout")) {
                    window.location.href = "/logout";
                } else if (command.includes("go to inbox") || command.includes("open inbox")) {
                    window.location.href = "/dashboard";
                } else if (command.includes("compose")) {
                    window.location.href = "/compose";
                } else if (command.includes("sent")) {
                    window.location.href = "/sent";
                } else if (command.includes("archive")) {
                    window.location.href = "/archive";
                } else {
                    alert("EVA heard: " + command + " but didn‚Äôt recognize it.");
                }
            };

            recognition.onerror = function (event) {
                alert("Voice recognition error: " + event.error);
            };

            recognition.onend = function () {
                console.log("EVA finished listening.");
            };
        }
        // function getFemaleVoice() {
        //     const voices = speechSynthesis.getVoices();
        //     const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
        //     const femaleVoice = englishVoices.find(voice =>
        //         /female|woman|girl|zira|samantha|amelie|victoria/i.test(voice.name)
        //     );
        //     return femaleVoice || englishVoices[0];
        // }

        // ============================ TEXT to Speech=======================

document.addEventListener("DOMContentLoaded", () => {
    let voices = [];

    function populateVoices() {
        voices = speechSynthesis.getVoices();
        document.querySelectorAll(".voiceSelect").forEach(select => {
            select.innerHTML = "";
            voices.forEach((voice, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang}) ${voice.default ? "[default]" : ""}`;
                select.appendChild(option);
            });

            const indianVoice = voices.find(v => v.lang.includes("en-IN") && v.name.toLowerCase().includes("female"));
            if (indianVoice) {
                select.value = voices.indexOf(indianVoice);
            }
        });
    }

    if (typeof speechSynthesis !== "undefined") {
        speechSynthesis.onvoiceschanged = populateVoices;
        populateVoices();
    }

    document.querySelectorAll(".read-aloud-btn").forEach(button => {
        button.addEventListener("click", () => {
            const container = button.closest(".email-details");
            const bodyElement = container.querySelector(".email-read-body");
            const voiceSelect = container.querySelector(".voiceSelect");

            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel();
                restoreOriginalHTML(bodyElement);
                button.innerHTML = `<i class="fas fa-volume-up"></i> Read Aloud`;
                return;
            }

            const originalHTML = bodyElement.innerHTML.trim();
            const plainText = bodyElement.textContent.trim();
            if (!plainText) {
                alert("No email body available to read.");
                return;
            }

            // Store original
            bodyElement.setAttribute("data-original-html", originalHTML);

            // Convert HTML to spans while preserving <br>
            const newHTML = [];
            bodyElement.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    const words = node.textContent.split(/\s+/).filter(w => w);
                    words.forEach((word, i) => {
                        newHTML.push(`<span class="word">${word}</span>${i < words.length - 1 ? ' ' : ''}`);
                    });
                } else if (node.nodeName === "BR") {
                    newHTML.push("<br>");
                } else {
                    newHTML.push(node.outerHTML);  // Keep <b>, <i>, etc.
                }
            });
            bodyElement.innerHTML = newHTML.join(" ");

            const utterance = new SpeechSynthesisUtterance(plainText);
            utterance.rate = 1;
            utterance.pitch = 1;

            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== "") {
                utterance.voice = voices[selectedIndex];
            }

            const spans = bodyElement.querySelectorAll(".word");
            let wordIndex = 0;

            button.innerHTML = `<i class="fas fa-stop"></i> Stop`;

            utterance.onboundary = function(event) {
                if (event.name === "word") {
                    if (wordIndex > 0 && spans[wordIndex - 1]) {
                        spans[wordIndex - 1].classList.remove("highlight");
                    }
                    if (wordIndex < spans.length && spans[wordIndex]) {
                        spans[wordIndex].classList.add("highlight");
                    }
                    wordIndex++;
                }
            };

            utterance.onend = () => {
                restoreOriginalHTML(bodyElement);
                button.innerHTML = `<i class="fas fa-volume-up"></i> Read Aloud`;
            };

            utterance.onerror = () => {
                restoreOriginalHTML(bodyElement);
                button.innerHTML = `<i class="fas fa-volume-up"></i> Read Aloud`;
            };

            speechSynthesis.speak(utterance);
        });
    });

    function restoreOriginalHTML(bodyElement) {
        const original = bodyElement.getAttribute("data-original-html");
        if (original) {
            bodyElement.innerHTML = original;
            bodyElement.removeAttribute("data-original-html");
        }
    }
});


    </script>



</body>

</html>